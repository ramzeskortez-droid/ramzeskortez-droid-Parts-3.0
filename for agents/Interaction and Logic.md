
# Взаимодействие, Логика и Структуры Данных

## 1. Структура Данных (TypeScript & JSON)

### 1.1. Модель `Order` (и `Offer`)
В коде используется единый интерфейс `Order` для обоих типов строк, различаемых полем `type`.

```typescript
interface Order {
  id: string;              // Уникальный ID (ORD-xxx или OFF-xxx)
  parentId?: string;       // Для Offer: ID родительского заказа
  type: 'ORDER' | 'OFFER'; // Тип строки
  status: 'ОТКРЫТ' | 'ЗАКРЫТ';
  
  // Данные авто и клиента
  vin: string;
  clientName: string;      // Имя клиента (для Order) или Поставщика (для Offer)
  car?: {                  // Данные авто (хранятся в JSON)
    model: string;
    year: string;
    engine: string;
    ...
  };

  // Позиции (Главный массив данных)
  items: OrderItem[];      

  // Системные поля
  createdAt: string;       // Дата создания (строка)
  isProcessed?: boolean;   // Флаг 'Y'/'N' (сформировано ли КП)
  readyToBuy?: boolean;    // Флаг 'Y'/'N' в Col M (подтверждение покупки)
  offers?: Order[];        // Только для frontend: вложенные офферы
}
```

---

## 2. Жизненный Цикл Сделки (State Machine)

### Этап 1: Создание (Client)
1.  Клиент заполняет форму.
2.  Отправляется `POST action='create'`.
3.  Бэкенд создает строку `ORDER`.
4.  `isProcessed = 'N'` (Клиент видит статус "В ожидании").

### Этап 2: Сбор Предложений (Seller)
1.  Поставщик видит `Order`.
2.  Заполняет цены и наличие.
3.  Отправляется `POST action='create'` (type='OFFER').
4.  Бэкенд находит строку `ORDER` и вставляет `OFFER` под ней.

### Этап 3: Модерация (Admin)
1.  Админ выбирает лучшие позиции (`Rank = LEADER`) и ставит цены продажи (`AdminPrice`).

### Этап 4: Формирование КП (Admin)
1.  Админ нажимает "Утвердить КП".
2.  `Processed = 'Y'` в строке `ORDER`.
3.  Клиент видит результат во вкладке "Предложения".

### Этап 5: Подтверждение Покупки (Client) - НОВОЕ
1.  Клиент нажимает кнопку **«Готов купить»**.
2.  Отправляется `POST action='confirm_purchase'`.
3.  Бэкенд:
    *   Ставит `readyToBuy = 'Y'` (Колонка M).
    *   Формирует детализированный отчет по всем `LEADER` позициям.
    *   Отправляет мгновенное уведомление в Telegram для Админа со списком товаров и итоговой суммой.

---

## 3. Backend Logic (Google Apps Script)

### Структура Таблицы (MarketData)
Колонки (индексы 0..12):

| Col Index | Header | Назначение |
| :--- | :--- | :--- |
| 0 (A) | ID | Первичный ключ |
| 7 (H) | **JSON** | **Источник истины.** |
| 11 (L)| Обработан | Флаг видимости для Клиента |
| 12 (M)| Готов купить| Флаг подтверждения сделки клиентом |
